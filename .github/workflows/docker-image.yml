name: Docker Image CI

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]

env:
  # CI-only database credentials (not secrets, safe for PRs)
  POSTGRES_USER: ci_user
  POSTGRES_PASSWORD: ci_password
  POSTGRES_DB: ci_citypulse

jobs:
#Later add test, lint, security-scan
  build:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U ci_user"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t citypulse:${{ github.sha }} -f backend/Dockerfile backend

      - name: Run container
        env:
          # Keep values out of the command line/logs; pass by variable name instead.
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          DATABASE_URL: postgresql://${{ env.POSTGRES_USER }}:${{ env.POSTGRES_PASSWORD }}@postgres:5432/${{ env.POSTGRES_DB }}
          BACKBOARD_API_KEY: ${{ github.event_name == 'push' && secrets.BACKBOARD_API_KEY || '' }}
        run: |
          docker run -d --name citypulse-test \
            --add-host=postgres:host-gateway \
            -p 8000:8000 \
            -e POSTGRES_USER \
            -e POSTGRES_PASSWORD \
            -e POSTGRES_DB \
            -e DATABASE_URL \
            -e BACKBOARD_API_KEY \
            citypulse:${{ github.sha }}

      - name: Wait for API and health check
        run: .github/scripts/health-check.sh citypulse-test

      - name: Verify secrets injected
        if: github.event_name == 'push'
        run: .github/scripts/verify-secrets.sh citypulse-test

      - name: Cleanup
        if: always()
        run: docker rm -f citypulse-test || true

